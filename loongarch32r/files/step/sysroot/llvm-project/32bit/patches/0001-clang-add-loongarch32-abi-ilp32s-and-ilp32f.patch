From b62b985f0dcfeb48d2a60998871857eb3032f5a9 Mon Sep 17 00:00:00 2001
From: Sun Haiyong <sunhaiyong@zdbr.net>
Date: Thu, 11 Sep 2025 15:08:26 +0000
Subject: [PATCH] clang add loongarch32 abi ilp32s and ilp32f.

---
 clang/lib/Driver/ToolChains/Gnu.cpp   |  4 +++-
 clang/lib/Driver/ToolChains/Linux.cpp | 17 +++++++++++++++--
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/clang/lib/Driver/ToolChains/Gnu.cpp b/clang/lib/Driver/ToolChains/Gnu.cpp
index 97851971..cd364f63 100644
--- a/clang/lib/Driver/ToolChains/Gnu.cpp
+++ b/clang/lib/Driver/ToolChains/Gnu.cpp
@@ -2385,7 +2385,9 @@ void Generic_GCC::GCCInstallationDetector::AddDefaultGCCPrefixes(
 
   static const char *const LoongArch32LibDirs[] = {"/lib32", "/lib"};
   static const char *const LoongArch32Triples[] = {
-      "loongarch32-linux-gnu", "loongarch32-unknown-linux-gnu"};
+      "loongarch32-linux-gnu", "loongarch32-unknown-linux-gnu",
+      "loongarch32-linux-gnuf32", "loongarch32-unknown-linux-gnuf32",
+      "loongarch32-linux-gnusf", "loongarch32-unknown-linux-gnusf"};
 
   static const char *const LoongArch64LibDirs[] = {"/lib64", "/lib"};
   static const char *const LoongArch64Triples[] = {
diff --git a/clang/lib/Driver/ToolChains/Linux.cpp b/clang/lib/Driver/ToolChains/Linux.cpp
index 16ea0b52..96ed02f7 100644
--- a/clang/lib/Driver/ToolChains/Linux.cpp
+++ b/clang/lib/Driver/ToolChains/Linux.cpp
@@ -203,10 +203,23 @@ static StringRef getOSLibDir(const llvm::Triple &Triple, const ArgList &Args) {
   if (Triple.getArch() == llvm::Triple::x86_64 && Triple.isX32())
     return "libx32";
 
-  if (Triple.getArch() == llvm::Triple::riscv32 ||
-      Triple.getArch() == llvm::Triple::loongarch32)
+  if (Triple.getArch() == llvm::Triple::riscv32)
     return "lib32";
 
+  if (Triple.getArch() == llvm::Triple::loongarch32){
+    switch (Triple.getEnvironment()) {
+    default:
+      return "lib32";
+    case llvm::Triple::GNUSF:
+    case llvm::Triple::MuslSF:
+      return "lib32/sf";
+    case llvm::Triple::GNUF32:
+    case llvm::Triple::MuslF32:
+      return "lib32/f32";
+    }
+
+  }
+
   return Triple.isArch32Bit() ? "lib" : "lib64";
 }
 
-- 
2.31.1

